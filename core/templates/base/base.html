{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>
      {% block title %}Sistema{% endblock %}
    </title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      :root {
        --sidebar-width: 260px;
        --sidebar-mini: 72px;
        --transition: 0.3s ease;
      }

      * { box-sizing: border-box; }

      body {
        background: #f4f6f9;
        overflow-x: hidden;
      }

      /* ===== OVERLAY (mobile) ===== */
      #sidebarOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1039;
      }

      #sidebarOverlay.active {
        display: block;
      }

      /* ===== LAYOUT ===== */
      .wrapper {
        display: flex;
      }

      /* ===== SIDEBAR ===== */
      #sidebar {
        width: var(--sidebar-width);
        min-height: 100vh;
        background: #111827;
        color: #fff;
        transition: width var(--transition);
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        overflow-x: hidden;
        overflow-y: auto;
        z-index: 1040;
        scrollbar-width: none;
      }

      #sidebar::-webkit-scrollbar { display: none; }

      /* collapsed — desktop */
      #sidebar.sidebar-collapsed {
        width: var(--sidebar-mini);
      }

      /* --- collapsed: hide text and chevron, center icons --- */
      #sidebar.sidebar-collapsed .sidebar-text {
        opacity: 0;
        width: 0;
        margin-left: 0;
        overflow: hidden;
        pointer-events: none;
      }

      /* chevron: hide AND remove from flow so it doesn't affect centering */
      #sidebar.sidebar-collapsed .rotate {
        display: none;
      }

      #sidebar.sidebar-collapsed .sidebar-menu a {
        justify-content: center;
        padding-left: 0;
        padding-right: 0;
      }

      /* submenus: visually hidden when collapsed (not hovering) */
      #sidebar.sidebar-collapsed:not(:hover) .submenu {
        visibility: hidden;
        height: 0;
        overflow: hidden;
      }

      /* hover expands on desktop */
      @media (min-width: 992px) {
        #sidebar.sidebar-collapsed:hover {
          width: var(--sidebar-width);
        }

        #sidebar.sidebar-collapsed:hover .sidebar-text {
          opacity: 1;
          width: auto;
          margin-left: 12px;
          pointer-events: auto;
        }

        #sidebar.sidebar-collapsed:hover .rotate {
          display: inline-block;
        }

        #sidebar.sidebar-collapsed:hover .sidebar-menu a {
          justify-content: flex-start;
          padding-left: 20px;
          padding-right: 20px;
        }

        /* restore submenu visibility on hover — JS controls Bootstrap collapse open/close */
        #sidebar.sidebar-collapsed:hover .submenu {
          visibility: visible;
          height: auto;
        }
      }

      /* tooltip on collapsed (desktop, no-hover) */
      @media (min-width: 992px) {
        #sidebar.sidebar-collapsed:not(:hover) .sidebar-menu > a[data-title]:hover::after {
          content: attr(data-title);
          position: absolute;
          left: calc(var(--sidebar-mini) + 8px);
          top: 50%;
          transform: translateY(-50%);
          background: #1f2937;
          color: #fff;
          padding: 5px 10px;
          border-radius: 6px;
          white-space: nowrap;
          font-size: 13px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 9999;
          pointer-events: none;
        }
      }

      /* mobile */
      @media (max-width: 991px) {
        #sidebar {
          transform: translateX(-100%);
          transition: transform var(--transition);
          width: var(--sidebar-width) !important;
        }

        #sidebar.mobile-open {
          transform: translateX(0);
        }
      }

      /* ===== SIDEBAR HEADER ===== */
      .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        font-weight: 600;
        font-size: 17px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        min-height: 60px;
        white-space: nowrap;
      }

      .toggle-btn {
        background: none;
        border: none;
        color: #cbd5e1;
        font-size: 22px;
        cursor: pointer;
        padding: 0;
        flex-shrink: 0;
        line-height: 1;
        transition: color 0.2s;
      }

      .toggle-btn:hover { color: #fff; }

      /* ===== MENU ===== */
      .sidebar-menu a {
        display: flex;
        align-items: center;
        padding: 11px 20px;
        color: #94a3b8;
        text-decoration: none;
        font-size: 14px;
        position: relative;
        transition: background 0.15s, color 0.15s;
        white-space: nowrap;
      }

      .sidebar-menu a:hover {
        background: #1f2937;
        color: #fff;
      }

      .sidebar-menu a.active {
        background: #2563eb;
        color: #fff;
      }

      .sidebar-menu i:first-child {
        font-size: 18px;
        width: 22px;
        text-align: center;
        flex-shrink: 0;
      }

      .sidebar-text {
        margin-left: 12px;
        transition: opacity var(--transition), width var(--transition);
        overflow: hidden;
      }

      .rotate {
        margin-left: auto;
        font-size: 13px;
        transition: transform 0.25s ease, opacity var(--transition), width var(--transition);
        flex-shrink: 0;
      }

      .rotate.open {
        transform: rotate(90deg);
      }

      /* ===== SUBMENU ===== */
      .submenu a {
        padding-left: 54px;
        font-size: 13px;
        color: #64748b;
      }

      .submenu a:hover { color: #fff; }
      .submenu a.active { color: #fff; background: #1d4ed8; }

      /* ===== MAIN ===== */
      .main {
        flex: 1;
        margin-left: var(--sidebar-width);
        transition: margin-left var(--transition);
        min-width: 0;
      }

      /* when sidebar is collapsed the main shifts */
      .main.sidebar-collapsed-main {
        margin-left: var(--sidebar-mini);
      }

      @media (max-width: 991px) {
        .main {
          margin-left: 0 !important;
        }
      }

      .topbar {
        height: 60px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.07);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .content {
        padding: 28px 30px;
      }
    </style>
  </head>

  <body>
    <div id="sidebarOverlay"></div>

    <div class="wrapper">
      <!-- SIDEBAR -->
      <div id="sidebar">
        <div class="sidebar-header">
          <span class="sidebar-text">Sistema</span>
          <button id="toggle-sidebar" class="toggle-btn" title="Recolher menu">
            <i class="bi bi-list"></i>
          </button>
        </div>

        <div class="sidebar-menu">
          <a href="{% url 'home' %}" data-title="Dashboard"
             class="{% if request.resolver_match.url_name == 'home' %}active{% endif %}">
            <i class="bi bi-speedometer2"></i>
            <span class="sidebar-text">Dashboard</span>
          </a>

          <a href="{% url 'business_update' request.user.business.id %}" data-title="Empresa"
             class="{% if 'business' in request.resolver_match.url_name %}active{% endif %}">
            <i class="bi bi-building"></i>
            <span class="sidebar-text">Empresa</span>
          </a>

          <a href="{% url 'user_list' %}" data-title="Usuários"
             class="{% if 'user' in request.resolver_match.url_name %}active{% endif %}">
            <i class="bi bi-person-gear"></i>
            <span class="sidebar-text">Usuários</span>
          </a>

          <a href="{% url 'client_list' %}" data-title="Clientes"
             class="{% if 'client' in request.resolver_match.url_name %}active{% endif %}">
            <i class="bi bi-people"></i>
            <span class="sidebar-text">Clientes</span>
          </a>

          <a href="{% url 'order_list' %}" data-title="Pedidos"
             class="{% if 'order' in request.resolver_match.url_name %}active{% endif %}">
            <i class="bi bi-bag"></i>
            <span class="sidebar-text">Pedidos</span>
          </a>

          <!-- ESTOQUE -->
          <a data-bs-toggle="collapse" href="#estoqueMenu" role="button" data-title="Estoque"
             class="{% if 'product' in request.resolver_match.url_name or 'chart' in request.resolver_match.url_name %}active{% endif %}">
            <i class="bi bi-box-seam"></i>
            <span class="sidebar-text">Estoque</span>
            <i class="bi bi-chevron-right rotate"></i>
          </a>
          <div class="collapse submenu {% if 'product' in request.resolver_match.url_name or 'chart' in request.resolver_match.url_name %}show{% endif %}"
               id="estoqueMenu">
            <a href="{% url 'product_list' %}" class="{% if 'product' in request.resolver_match.url_name %}active{% endif %}">Produtos</a>
            <a href="{% url 'colorchart_list' %}" class="{% if 'colorchart' in request.resolver_match.url_name %}active{% endif %}">Cores</a>
            <a href="{% url 'modelchart_list' %}" class="{% if 'modelchart' in request.resolver_match.url_name %}active{% endif %}">Modelos</a>
            <a href="{% url 'sizechart_list' %}" class="{% if 'sizechart' in request.resolver_match.url_name %}active{% endif %}">Tamanhos</a>
          </div>

          <!-- FISCAL -->
          <a data-bs-toggle="collapse" href="#configFiscal" role="button" data-title="Fiscal"
             class="{% if 'ncm' in request.resolver_match.url_name or 'operation' in request.resolver_match.url_name %}active{% endif %}">
            <i class="bi bi-receipt"></i>
            <span class="sidebar-text">Fiscal</span>
            <i class="bi bi-chevron-right rotate"></i>
          </a>
          <div class="collapse submenu {% if 'ncm' in request.resolver_match.url_name or 'operation' in request.resolver_match.url_name %}show{% endif %}"
               id="configFiscal">
            <a href="{% url 'ncm_group_list' %}" class="{% if 'ncm_group' in request.resolver_match.url_name %}active{% endif %}">Grupos NCM</a>
            <a href="{% url 'operation_list' %}" class="{% if 'operation' in request.resolver_match.url_name %}active{% endif %}">Operações Fiscais</a>
          </div>

          <!-- LOGOUT -->
          <form action="{% url 'logout' %}" method="post" id="logout-form" class="d-none">
            {% csrf_token %}
          </form>
          <a href="#" data-title="Sair" onclick="document.getElementById('logout-form').submit(); return false;">
            <i class="bi bi-box-arrow-right"></i>
            <span class="sidebar-text">Sair</span>
          </a>
        </div>
      </div>

      <!-- MAIN -->
      <div class="main" id="main">
        <div class="topbar">
          <div class="d-flex align-items-center gap-3">
            <!-- mobile toggle inside topbar -->
            <button id="mobile-toggle" class="btn btn-sm btn-light d-lg-none">
              <i class="bi bi-list fs-5"></i>
            </button>
            <strong>{{ request.user.business.name }}</strong>
          </div>
          <span class="text-muted small">{{ request.user.username }}</span>
        </div>

        <div class="content">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}

          {% block content %}{% endblock %}
        </div>
      </div>
    </div>

    <script src="{% static 'js/base.js' %}"></script>
    {% block extra_js %}{% endblock %}
  </body>
</html>
