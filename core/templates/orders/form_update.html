{% extends 'base/base.html' %}
{% load static %}

{% block title %}Editar Pedido{% endblock %}

{% block content %}

<!-- SELECT2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- ===== CABE√áALHO ===== -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
    <div class="d-flex align-items-center gap-3">
        <h2 class="mb-0">Pedido #{{ order.id }}</h2>

        <!-- Badge NF-e / NFC-e -->
        {% if order.document_model == '55' %}
            <span class="badge bg-primary fs-6 px-3 py-2">üßæ NF-e</span>
        {% elif order.document_model == '65' %}
            <span class="badge bg-success fs-6 px-3 py-2">üõí NFC-e</span>
        {% else %}
            <span class="badge bg-secondary fs-6 px-3 py-2">Sem modelo definido</span>
        {% endif %}

        <!-- Badge Status -->
        <span class="badge
            {% if order.status == 'DIGITACAO' %}bg-secondary
            {% elif order.status == 'ORCAMENTO' %}bg-info text-dark
            {% elif order.status == 'EM_SEPARACAO' %}bg-warning text-dark
            {% elif order.status == 'SEPARADO' %}bg-primary
            {% elif order.status == 'FATURADO' %}bg-success
            {% elif order.status == 'CANCELADO' %}bg-danger
            {% endif %} fs-6 px-3 py-2">
            {{ order.get_status_display }}
        </span>
    </div>

    <div class="d-flex gap-2">

        <!-- ===== BOT√ÉO GERAR NF ‚Äî s√≥ aparece quando FATURADO e sem NF ativa ===== -->
        {% if order.status == 'FATURADO' %}
            {% with nf_ativa=order.invoices.filter %}
                {% if not invoice_ativa %}
                    <button type="button"
                            class="btn btn-success fw-semibold px-4"
                            data-bs-toggle="modal"
                            data-bs-target="#modalGerarNF">
                        üßæ Gerar
                        {% if order.document_model == '55' %}NF-e{% elif order.document_model == '65' %}NFC-e{% else %}NF{% endif %}
                    </button>
                {% else %}
                    <!-- NF j√° existe ‚Äî link para visualizar -->
                    <a href="{% url 'invoice_detail' invoice_ativa.pk %}"
                       class="btn btn-outline-success fw-semibold px-4">
                        üßæ Ver
                        {% if order.document_model == '55' %}NF-e{% else %}NFC-e{% endif %}
                        {{ invoice_ativa.serie }}/{{ invoice_ativa.number }}
                    </a>
                {% endif %}
            {% endwith %}
        {% endif %}

        <a href="{% url 'order_list' %}" class="btn btn-outline-secondary">‚Üê Voltar</a>
    </div>
</div>

{% if order.status not in 'DIGITACAO,ORCAMENTO' %}
<div class="alert alert-warning border-warning d-flex align-items-start gap-2">
    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
    <div>
        <h6 class="mb-1 fw-bold">Pedido bloqueado para edi√ß√£o</h6>
        <p class="mb-0">
            Este pedido encontra-se em status
            <strong>{{ order.get_status_display }}</strong>
            e n√£o pode mais ser alterado.
        </p>
    </div>
</div>
{% endif %}

<form method="post"
      class="{% if order.status != order.STATUS_DIGITACAO and order.status != order.STATUS_ORCAMENTO %}order-locked{% endif %}">
    {% csrf_token %}

    <!-- ===== CLIENTE ===== -->
    <div class="card shadow-sm p-3 mb-4 border-0">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label fw-semibold mb-0">Cliente</label>
            {% if order.document_model == '65' %}
                <span class="text-muted small">‚ÑπÔ∏è NFC-e ‚Äî cliente opcional</span>
            {% endif %}
        </div>
        {{ form.client }}
    </div>

    <!-- ===== ADICIONAR ITEM ===== -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 fw-semibold">Adicionar Item</h5>
            </div>

            <div class="row g-3 align-items-end">

                <div class="col-lg-5 col-md-12">
                    <label class="form-label fw-semibold">Produto / Tamanho</label>
                    <select id="product" class="form-control w-100"></select>
                </div>

                <div class="col-lg-2 col-md-4">
                    <label class="form-label fw-semibold">Tipo</label>
                    <select id="price_type" class="form-select">
                        <option value="price">Varejo</option>
                        <option value="price1">Atacado</option>
                    </select>
                </div>

                <div class="col-lg-1 col-md-2">
                    <label class="form-label fw-semibold">Qtd</label>
                    <input id="quantity" type="number" min="1" class="form-control text-center" value="1">
                </div>

                <div class="col-lg-2 col-md-3">
                    <label class="form-label fw-semibold">Pre√ßo</label>
                    <input id="price" type="number" step="0.01" class="form-control text-end">
                </div>

                <div class="col-lg-1 col-md-3">
                    <label class="form-label fw-semibold">Desc.</label>
                    <input id="discount" type="number" step="0.01" class="form-control text-end" value="0">
                </div>

                <div class="col-lg-1 col-md-3">
                    <label class="form-label fw-semibold">Acr√©s.</label>
                    <input id="addition" type="number" step="0.01" class="form-control text-end" value="0">
                </div>

                <!-- Preview fiscal -->
                <div class="col-12" id="fiscal-preview" style="display:none">
                    <div class="alert alert-light border small py-2 mb-0">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto"><strong>Fiscal:</strong></div>
                            <div class="col-auto">CFOP: <strong id="fp-cfop">‚Äî</strong></div>
                            <div class="col-auto">NCM: <strong id="fp-ncm">‚Äî</strong></div>
                            <div class="col-auto">CST/CSOSN: <strong id="fp-cst">‚Äî</strong></div>
                            <div class="col-auto">ICMS: <strong id="fp-icms">‚Äî</strong></div>
                            <div class="col-auto">PIS: <strong id="fp-pis">‚Äî</strong></div>
                            <div class="col-auto">COFINS: <strong id="fp-cofins">‚Äî</strong></div>
                        </div>
                    </div>
                </div>

                <div id="fiscal-warning" class="col-12" style="display:none">
                    <div class="alert alert-warning small py-2 mb-0">
                        ‚ö†Ô∏è Nenhuma opera√ß√£o fiscal encontrada para este produto.
                        Verifique o NCM e as opera√ß√µes fiscais cadastradas.
                    </div>
                </div>

                <div class="col-12 mt-3">
                    <button type="button" id="add-item-btn" class="btn btn-success w-100 fw-semibold py-2">
                        ‚ûï Adicionar ao Pedido
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- ===== ITENS DO PEDIDO ===== -->
    <div class="card shadow-sm p-3 mb-4 border-0">
        <h5 class="mb-3">Itens do Pedido</h5>

        {{ formset.management_form }}
        {{ payment_formset.management_form }}

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:30%">Produto / Tamanho</th>
                        <th style="width:8%">Qtd</th>
                        <th style="width:12%">Pre√ßo</th>
                        <th style="width:10%">Desc.</th>
                        <th style="width:10%">Acr√©s.</th>
                        <th style="width:8%" class="text-center">CFOP</th>
                        <th style="width:8%" class="text-center">ICMS%</th>
                        <th style="width:10%" class="text-end">Subtotal</th>
                        <th style="width:4%"></th>
                    </tr>
                </thead>
                <tbody id="items-table">
                    {% for form in formset %}
                    <tr class="item-form">
                        <td>{{ form.variant }}</td>
                        <td>{{ form.quantity }}</td>
                        <td>{{ form.price }}</td>
                        <td>{{ form.discount }}</td>
                        <td>{{ form.addition }}</td>
                        <td class="text-center text-muted small">{{ form.instance.cfop|default:"‚Äî" }}</td>
                        <td class="text-center text-muted small">
                            {% if form.instance.icms_rate %}{{ form.instance.icms_rate }}%{% else %}‚Äî{% endif %}
                        </td>
                        <td class="subtotal text-end fw-semibold">R$ 0,00</td>
                        <td class="text-center">
                            {{ form.id }}
                            {{ form.DELETE }}
                            <button type="button" class="btn btn-outline-danger btn-sm remove-item">‚úï</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <h4>Total: <span id="total" class="fw-bold text-success">R$ 0,00</span></h4>
        </div>
    </div>

    <!-- ===== FORMAS DE PAGAMENTO ===== -->
    <div class="card mt-4">
        <div class="card-header bg-light d-flex justify-content-between flex-wrap gap-2">
            <strong>Formas de Pagamento</strong>
            <div>
                Total: <strong id="total-pedido" data-valor="{{ total_order|floatformat:2 }}">R$ {{ total_order|floatformat:2 }}</strong>
                <span class="ms-3">Pago: <strong id="total-pagamentos">R$ {{ total_payments|floatformat:2 }}</strong></span>
                <span class="ms-3">
                    Saldo: <strong id="saldo-pedido" class="{% if saldo > 0 %}text-danger{% else %}text-success{% endif %}">
                        R$ {{ saldo|floatformat:2 }}
                    </strong>
                </span>
            </div>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Forma</th>
                        <th>Banco</th>
                        <th width="120">Valor</th>
                        <th width="100">Parcelas</th>
                        <th width="120">Intervalo</th>
                        <th width="60"></th>
                    </tr>
                </thead>
                <tbody id="payments-table">
                    {% for form in payment_formset %}
                    <tr class="payment-row">
                        <td>{{ form.id }}{{ form.payment_method }}</td>
                        <td>{{ form.bank }}</td>
                        <td>{{ form.total_value }}</td>
                        <td>{{ form.parcels }}</td>
                        <td>{{ form.interval_days }}</td>
                        <td>
                            {{ form.DELETE }}
                            <button type="button" class="btn btn-sm btn-danger remove-payment">‚úï</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="button" id="add-payment" class="btn btn-success mt-2">‚ûï Adicionar Pagamento</button>

            <div id="msg-pago"    class="alert alert-success mt-3 d-none">‚úî Pagamento Efetuado</div>
            <div id="msg-parcial" class="alert alert-warning mt-3 d-none">‚ö† Pagamento Pendente</div>
        </div>
    </div>

    <!-- ===== PARCELAS GERADAS ===== -->
    {% if order.payments.exists %}
    <div class="card mt-4 border-success">
        <div class="card-header bg-success text-white">
            <strong>Parcelas Geradas</strong>
        </div>
        <div class="card-body">
            {% for payment in order.payments.all %}
                {% if payment.parcels_records.exists %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between">
                        <div>
                            <strong>{{ payment.payment_method }}</strong>
                            {% if payment.bank %} - {{ payment.bank }}{% endif %}
                        </div>
                        <div>Total: <strong>R$ {{ payment.total_value|floatformat:2 }}</strong> | {{ payment.parcels }}x</div>
                    </div>
                    <div class="card-body p-2">
                        <table class="table table-sm table-striped table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="60">#</th>
                                    <th>Vencimento</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for parcel in payment.parcels_records.all %}
                                <tr>
                                    <td>{{ parcel.parcel_number }}</td>
                                    <td>{{ parcel.due_date|date:"d/m/Y" }}</td>
                                    <td>R$ {{ parcel.value|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            {% empty %}
                <div class="alert alert-warning mb-0">Nenhuma parcela gerada ainda.</div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ===== SALVAR ===== -->
    <div class="d-flex justify-content-end mt-4">
        <button class="btn btn-primary btn-lg px-5">üíæ Salvar Pedido</button>
    </div>

</form>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL ‚Äî GERAR NF-e / NFC-e
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if order.status == 'FATURADO' and not invoice_ativa %}
<div class="modal fade" id="modalGerarNF" tabindex="-1" aria-labelledby="modalGerarNFLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">

            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalGerarNFLabel">
                    üßæ Confirmar Gera√ß√£o de
                    {% if order.document_model == '55' %}NF-e{% elif order.document_model == '65' %}NFC-e{% else %}Nota Fiscal{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body pt-3">

                <!-- Resumo do pedido -->
                <div class="rounded-3 p-3 mb-3" style="background:#f8f9fa;">
                    <div class="row g-2 small">
                        <div class="col-6">
                            <span class="text-muted">Pedido</span><br>
                            <strong>#{{ order.id }}</strong>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">Modelo</span><br>
                            <strong>
                                {% if order.document_model == '55' %}NF-e (55){% elif order.document_model == '65' %}NFC-e (65){% else %}‚Äî{% endif %}
                            </strong>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">Cliente</span><br>
                            <strong>{{ order.client.name|default:"Consumidor Final" }}</strong>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">Total</span><br>
                            <strong class="text-success">R$ {{ order.total_amount|floatformat:2 }}</strong>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">S√©rie</span><br>
                            <strong>
                                {% if order.document_model == '55' %}{{ order.business.nfe_series }}{% else %}{{ order.business.nfce_series }}{% endif %}
                            </strong>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">Pr√≥ximo n√∫mero</span><br>
                            <strong>
                                {% if order.document_model == '55' %}{{ order.business.nfe_last_number|add:1 }}{% else %}{{ order.business.nfce_last_number|add:1 }}{% endif %}
                            </strong>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">Ambiente</span><br>
                            {% if order.business.nfe_environment == 2 %}
                                <span class="badge bg-warning text-dark">Homologa√ß√£o</span>
                            {% else %}
                                <span class="badge bg-success">Produ√ß√£o</span>
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <span class="text-muted">Itens</span><br>
                            <strong>{{ order.items.count }} produto{{ order.items.count|pluralize }}</strong>
                        </div>
                    </div>
                </div>

                <!-- Aviso homologa√ß√£o -->
                {% if order.business.nfe_environment == 2 %}
                <div class="alert alert-warning py-2 small mb-3">
                    ‚ö†Ô∏è <strong>Ambiente de Homologa√ß√£o</strong> ‚Äî esta NF <u>n√£o tem validade fiscal</u>.
                    Configure o ambiente em <strong>Empresa ‚Üí Editar</strong> para emitir em Produ√ß√£o.
                </div>
                {% endif %}

                <!-- Aviso itens sem fiscal -->
                {% for item in order.items.all %}
                    {% if not item.cfop %}
                    <div class="alert alert-danger py-2 small mb-3">
                        ‚õî O item <strong>{{ item.variant.product.name }}</strong> n√£o possui CFOP definido.
                        Salve o pedido para aplicar as regras fiscais antes de gerar a NF.
                    </div>
                    {% endif %}
                {% endfor %}

                <p class="text-muted small mb-0">
                    A nota ser√° gerada com status <strong>Rascunho</strong>. Voc√™ poder√° revisar antes de transmitir √† SEFAZ.
                </p>

            </div>

            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>

                <!-- POST para a view gerar_nfe -->
                <form method="post" action="{% url 'gerar_nfe' order.pk %}" id="form-gerar-nf">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success fw-semibold px-4" id="btn-confirmar-gerar">
                        <span id="btn-gerar-texto">
                            ‚úÖ Gerar
                            {% if order.document_model == '55' %}NF-e{% elif order.document_model == '65' %}NFC-e{% else %}NF{% endif %}
                        </span>
                        <span id="btn-gerar-loading" class="d-none">
                            <span class="spinner-border spinner-border-sm me-1"></span> Gerando...
                        </span>
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
/* Spinner enquanto gera a NF */
document.getElementById('form-gerar-nf').addEventListener('submit', function () {
    document.getElementById('btn-gerar-texto').classList.add('d-none');
    document.getElementById('btn-gerar-loading').classList.remove('d-none');
    document.getElementById('btn-confirmar-gerar').disabled = true;
});
</script>
{% endif %}

<!-- ===== TEMPLATES DJANGO (hidden) ===== -->
<template id="empty-payment-template">
<tr class="payment-row">
    <td>{{ payment_formset.empty_form.payment_method }}</td>
    <td>{{ payment_formset.empty_form.bank }}</td>
    <td>{{ payment_formset.empty_form.total_value }}</td>
    <td>{{ payment_formset.empty_form.parcels }}</td>
    <td>{{ payment_formset.empty_form.interval_days }}</td>
    <td>
        {{ payment_formset.empty_form.DELETE }}
        <button type="button" class="btn btn-sm btn-danger remove-payment">‚úï</button>
    </td>
</tr>
</template>

<template id="empty-form-template">
<tr class="item-form">
    <td>{{ formset.empty_form.variant }}</td>
    <td>{{ formset.empty_form.quantity }}</td>
    <td>{{ formset.empty_form.price }}</td>
    <td>{{ formset.empty_form.discount }}</td>
    <td>{{ formset.empty_form.addition }}</td>
    <td class="text-center text-muted small">‚Äî</td>
    <td class="text-center text-muted small">‚Äî</td>
    <td class="subtotal text-end fw-semibold">R$ 0,00</td>
    <td class="text-center">
        {{ formset.empty_form.id }}
        {{ formset.empty_form.DELETE }}
        <button type="button" class="btn btn-outline-danger btn-sm remove-item">‚úï</button>
    </td>
</tr>
</template>

{% include 'orders/status_block.html' %}

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/order_form.js' %}?v={{ order.id }}-2"></script>

<script>
/* ================================================================
   PREVIEW FISCAL
================================================================ */
const ORDER_ID   = {{ order.id }};
const FISCAL_URL = "{% url 'ajax_fiscal_item' %}";

window.fetchFiscalPreview = function (variantId, quantity, price, discount, addition) {

    if (!variantId) {
        document.getElementById('fiscal-preview').style.display = 'none';
        document.getElementById('fiscal-warning').style.display = 'none';
        return;
    }

    const params = new URLSearchParams({
        variant_id: variantId,
        order_id:   ORDER_ID,
        quantity:   quantity  || 1,
        price:      price     || 0,
        discount:   discount  || 0,
        addition:   addition  || 0,
    });

    fetch(`${FISCAL_URL}?${params}`)
        .then(r => r.json())
        .then(function (data) {
            const preview = document.getElementById('fiscal-preview');
            const warning = document.getElementById('fiscal-warning');

            if (!data.found) {
                preview.style.display = 'none';
                warning.style.display = '';
                return;
            }

            warning.style.display = 'none';
            preview.style.display = '';

            document.getElementById('fp-cfop').textContent   = data.cfop   || '‚Äî';
            document.getElementById('fp-ncm').textContent    = data.ncm    || '‚Äî';
            document.getElementById('fp-cst').textContent    = data.icms_csosn || data.icms_cst || '‚Äî';
            document.getElementById('fp-icms').textContent   = data.icms_value
                ? `R$ ${parseFloat(data.icms_value).toFixed(2)} (${data.icms_rate}%)`
                : '‚Äî';
            document.getElementById('fp-pis').textContent    = data.pis_value
                ? `R$ ${parseFloat(data.pis_value).toFixed(2)}`
                : '‚Äî';
            document.getElementById('fp-cofins').textContent = data.cofins_value
                ? `R$ ${parseFloat(data.cofins_value).toFixed(2)}`
                : '‚Äî';
        })
        .catch(function () {
            document.getElementById('fiscal-preview').style.display = 'none';
        });
};

/* ================================================================
   FINANCEIRO
================================================================ */
document.addEventListener('DOMContentLoaded', function () {

    const totalPedidoEl     = document.getElementById('total-pedido');
    const totalPagamentosEl = document.getElementById('total-pagamentos');
    const saldoEl           = document.getElementById('saldo-pedido');
    const pagoMsg           = document.getElementById('msg-pago');
    const parcialMsg        = document.getElementById('msg-parcial');
    const form              = document.querySelector('form');

    function parseValue(v) { return parseFloat(v) || 0; }
    function formatMoney(v) {
        return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    window.calcularSaldo = function () {
        const totalPedido = parseFloat(totalPedidoEl.dataset.valor || 0);
        let totalPagamentos = 0;

        document.querySelectorAll('#payments-table tr').forEach(function (row) {
            if (row.style.display === 'none') return;
            const input = row.querySelector('input[name$="total_value"]');
            if (input) totalPagamentos += parseValue(input.value);
        });

        let saldo = totalPedido - totalPagamentos;
        if (saldo < 0) saldo = 0;

        totalPagamentosEl.innerText = 'R$ ' + formatMoney(totalPagamentos);
        saldoEl.innerText           = 'R$ ' + formatMoney(saldo);
        saldoEl.classList.remove('text-success', 'text-danger');
        pagoMsg.classList.add('d-none');
        parcialMsg.classList.add('d-none');

        if (saldo === 0 && totalPedido > 0) {
            saldoEl.classList.add('text-success');
            pagoMsg.classList.remove('d-none');
        } else if (saldo > 0) {
            saldoEl.classList.add('text-danger');
            parcialMsg.classList.remove('d-none');
        }

        return saldo;
    };

    form.addEventListener('submit', function (e) {
        const saldo = calcularSaldo();
        if (saldo > 0) {
            e.preventDefault();
            alert('N√£o √© poss√≠vel salvar pedido com saldo pendente.');
            return false;
        }
    });

    document.getElementById('add-payment').addEventListener('click', function () {
        const totalForms = document.getElementById('id_payments-TOTAL_FORMS');
        const count      = parseInt(totalForms.value);
        const html = document.getElementById('empty-payment-template')
                             .innerHTML.replace(/__prefix__/g, count);
        document.getElementById('payments-table').insertAdjacentHTML('beforeend', html);
        totalForms.value = count + 1;
    });

    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-payment')) {
            const row = e.target.closest('tr');
            const cb  = row.querySelector('input[type="checkbox"]');
            if (cb) cb.checked = true;
            row.style.display = 'none';
            calcularSaldo();
        }
    });

    document.addEventListener('input', function (e) {
        if (e.target.name && e.target.name.includes('total_value')) calcularSaldo();
    });

    calcularSaldo();
});
</script>

<style>
.order-locked input,
.order-locked select,
.order-locked textarea,
.order-locked button { pointer-events: none; opacity: 0.6; }
.order-locked input,
.order-locked select,
.order-locked textarea { background-color: #f8f9fa !important; }

.select2-container .select2-selection--single          { height: 38px; padding: 4px 8px; }
.select2-container--default .select2-selection--single { border: 1px solid #ced4da; border-radius: .375rem; }
.select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 28px; }
</style>

{% endblock %}