{% extends 'base/base.html' %}
{% load static %}

{% block title %}Editar Pedido{% endblock %}

{% block content %}

<!-- SELECT2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
    <h2 class="mb-4">Pedido #{{ order.id }}</h2>

    <a href="{% url 'order_list' %}" class="btn btn-outline-secondary">
        ‚Üê Voltar
    </a>
</div>

{% if order.status not in 'EM_DIGITACAO,ORCAMENTO' %}
<div class="alert alert-warning border-warning d-flex align-items-start gap-2">
    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
    <div>
        <h6 class="mb-1 fw-bold">Pedido bloqueado para edi√ß√£o</h6>
        <p class="mb-0">
            Este pedido encontra-se em status
            <strong>{{ order.get_status_display }}</strong>
            e n√£o pode mais ser alterado.
        </p>
    </div>
</div>
{% endif %}

<form method="post"
      class="{% if order.status != order.STATUS_DIGITACAO and order.status != order.STATUS_ORCAMENTO %}order-locked{% endif %}">
    {% csrf_token %}

    <!-- CLIENTE -->
    <div class="card shadow-sm p-3 mb-4 border-0">
        <label class="form-label fw-semibold">Cliente</label>
        {{ form.client }}
    </div>

    <!-- ADICIONAR ITEM -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 fw-semibold">
                    Adicionar Item
                </h5>
            </div>

            <div class="row g-3 align-items-end">

                <div class="col-lg-5 col-md-12">
                    <label class="form-label fw-semibold">
                        Produto / Tamanho
                    </label>
                    <select id="product" class="form-control w-100"></select>
                </div>

                <div class="col-lg-2 col-md-4">
                    <label class="form-label fw-semibold">Tipo</label>
                    <select id="price_type" class="form-select">
                        <option value="price">Varejo</option>
                        <option value="price1">Atacado</option>
                    </select>
                </div>

                <div class="col-lg-1 col-md-2">
                    <label class="form-label fw-semibold">Qtd</label>
                    <input id="quantity"
                           type="number"
                           min="1"
                           class="form-control text-center"
                           value="1">
                </div>

                <div class="col-lg-2 col-md-3">
                    <label class="form-label fw-semibold">Pre√ßo</label>
                    <input id="price"
                           type="number"
                           step="0.01"
                           class="form-control text-end">
                </div>

                <div class="col-lg-1 col-md-3">
                    <label class="form-label fw-semibold">Desc.</label>
                    <input id="discount"
                           type="number"
                           step="0.01"
                           class="form-control text-end"
                           value="0">
                </div>

                <div class="col-lg-1 col-md-3">
                    <label class="form-label fw-semibold">Acr√©s.</label>
                    <input id="addition"
                           type="number"
                           step="0.01"
                           class="form-control text-end"
                           value="0">
                </div>

                <div class="col-12 mt-3">
                    <button type="button"
                            id="add-item-btn"
                            class="btn btn-success w-100 fw-semibold py-2">
                        ‚ûï Adicionar ao Pedido
                    </button>
                </div>

            </div>

        </div>
    </div>

    <!-- ITENS -->
    <div class="card shadow-sm p-3 mb-4 border-0">
        <h5 class="mb-3">Itens do Pedido</h5>

        {{ formset.management_form }}
        {{ payment_formset.management_form }}

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 30%">Produto / Tamanho</th>
                        <th style="width: 8%">Qtd</th>
                        <th style="width: 12%">Pre√ßo</th>
                        <th style="width: 10%">Desc.</th>
                        <th style="width: 10%">Acr√©s.</th>
                        <th style="width: 12%" class="text-end">Subtotal</th>
                        <th style="width: 5%"></th>
                    </tr>
                </thead>

                <tbody id="items-table">
                    {% for form in formset %}
                    <tr class="item-form">
                        <td>{{ form.variant }}</td>
                        <td>{{ form.quantity }}</td>
                        <td>{{ form.price }}</td>
                        <td>{{ form.discount }}</td>
                        <td>{{ form.addition }}</td>
                        <td class="subtotal text-end fw-semibold">R$ 0,00</td>
                        <td class="text-center">
                            {{ form.id }}
                            {{ form.DELETE }}
                            <button type="button"
                                    class="btn btn-outline-danger btn-sm remove-item">
                                ‚úï
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <h4>
                Total: <span id="total" class="fw-bold text-success">R$ 0,00</span>
            </h4>
        </div>
    </div>

<!-- ============================= -->
<!-- FORMAS DE PAGAMENTO -->
<!-- ============================= -->
<div class="card mt-4">
    <div class="card-header bg-light d-flex justify-content-between">
        <strong>Formas de Pagamento</strong>

        <div>
            Total:
            <strong id="total-pedido"
                data-valor="{{ total_order|floatformat:2 }}">
                R$ {{ total_order|floatformat:2 }}
            </strong>

            <span class="ms-3">
                Pago:
                <strong id="total-pagamentos">
                    R$ {{ total_payments|floatformat:2 }}
                </strong>
            </span>

            <span class="ms-3">
                Saldo:
                <strong id="saldo-pedido"
                        class="{% if saldo > 0 %}text-danger{% else %}text-success{% endif %}">
                    R$ {{ saldo|floatformat:2 }}
                </strong>
            </span>
        </div>
    </div>

    <div class="card-body">

        {% comment %} {{ payment_formset.management_form }} {% endcomment %}

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Forma</th>
                    <th>Banco</th>
                    <th width="120">Valor</th>
                    <th width="100">Parcelas</th>
                    <th width="120">Intervalo</th>
                    <th width="60"></th>
                </tr>
            </thead>

            <tbody id="payments-table">
                {% for form in payment_formset %}
                <tr class="payment-row">
                    <td>{{ form.id }}{{ form.payment_method }}</td>
                    <td>{{ form.bank }}</td>
                    <td>{{ form.total_value }}</td>
                    <td>{{ form.parcels }}</td>
                    <td>{{ form.interval_days }}</td>
                    <td>
                        {{ form.DELETE }}
                        <button type="button" class="btn btn-sm btn-danger remove-payment">‚úï</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="button"
                id="add-payment"
                class="btn btn-success mt-2">
            ‚ûï Adicionar Pagamento
        </button>

        <div id="msg-pago" class="alert alert-success mt-3 d-none">
            ‚úî Pagamento Efetuado
        </div>

        <div id="msg-parcial" class="alert alert-warning mt-3 d-none">
            ‚ö† Pagamento Pendente
        </div>

    </div>
</div>

{% comment %} <template id="empty-payment-form">
<tr class="payment-form">
    <td>{{ payment_formset.empty_form.payment_method }}</td>
    <td>{{ payment_formset.empty_form.bank }}</td>
    <td>{{ payment_formset.empty_form.total_value }}</td>
    <td>{{ payment_formset.empty_form.parcels }}</td>
    <td>{{ payment_formset.empty_form.interval_days }}</td>
    <td class="text-center">
        {{ payment_formset.empty_form.DELETE }}
        <button type="button"
                class="btn btn-sm btn-outline-danger remove-payment">
            ‚úï
        </button>
    </td>
</tr>
</template> {% endcomment %}

<!-- ============================= -->
<!-- PARCELAS GERADAS -->
<!-- ============================= -->
{% if order.payments.exists %}
    {% if order.pk and order.payments.exists %}
        <div class="card mt-4 border-success">
            <div class="card-header bg-success text-white">
                <strong>Parcelas Geradas</strong>
            </div>

            <div class="card-body">

                {% for payment in order.payments.all %}
                    {% if payment.parcels_records.exists %}

                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between">
                                <div>
                                    <strong>
                                        {{ payment.get_payment_method_display }}
                                    </strong>
                                    {% if payment.bank %}
                                        - {{ payment.bank }}
                                    {% endif %}
                                </div>
                                <div>
                                    Total: <strong>R$ {{ payment.total_value|floatformat:2 }}</strong>
                                    | {{ payment.parcels }}x
                                </div>
                            </div>

                            <div class="card-body p-2">

                                <div class="table-responsive">
                                    <table class="table table-sm table-striped table-bordered mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="60">#</th>
                                                <th>Vencimento</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for parcel in payment.parcels_records.all %}
                                                <tr>
                                                    <td>{{ parcel.number }}</td>
                                                    <td>{{ parcel.due_date|date:"d/m/Y" }}</td>
                                                    <td>R$ {{ parcel.value|floatformat:2 }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>

                    {% endif %}
                {% empty %}
                    <div class="alert alert-warning mb-0">
                        Nenhuma parcela gerada ainda.
                    </div>
                {% endfor %}

            </div>
        </div>
    {% endif %}
{% endif %}

    <div class="d-flex justify-content-end">
        <button class="btn btn-primary btn-lg">
            üíæ Salvar Pedido
        </button>
    </div>
</form>

<template id="empty-payment-template">
<tr class="payment-row">
    <td>{{ payment_formset.empty_form.payment_method }}</td>
    <td>{{ payment_formset.empty_form.bank }}</td>
    <td>{{ payment_formset.empty_form.total_value }}</td>
    <td>{{ payment_formset.empty_form.parcels }}</td>
    <td>{{ payment_formset.empty_form.interval_days }}</td>
    <td>
        {{ payment_formset.empty_form.DELETE }}
        <button type="button" class="btn btn-sm btn-danger remove-payment">‚úï</button>
    </td>
</tr>
</template>

<template id="empty-form-template">
<tr class="item-form">
    <td>{{ formset.empty_form.variant }}</td>
    <td>{{ formset.empty_form.quantity }}</td>
    <td>{{ formset.empty_form.price }}</td>
    <td>{{ formset.empty_form.discount }}</td>
    <td>{{ formset.empty_form.addition }}</td>
    <td class="subtotal text-end fw-semibold">R$ 0,00</td>
    <td class="text-center">
        {{ formset.empty_form.id }}
        {{ formset.empty_form.DELETE }}
        <button type="button"
                class="btn btn-outline-danger btn-sm remove-item">
            ‚úï
        </button>
    </td>
</tr>
</template>


{% include 'orders/status_block.html' %}

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="{% static 'js/order_form.js' %}"></script>

<style>

/* BLOQUEIO FUNCIONAL IGUAL AO TEMPLATE 2 */
.order-locked {
    position: relative;
}

.order-locked input,
.order-locked select,
.order-locked textarea,
.order-locked button {
    pointer-events: none;
    opacity: 0.6;
}

.order-locked input,
.order-locked select,
.order-locked textarea {
    background-color: #f8f9fa !important;
}

.order-locked .btn:hover {
    filter: none;
}

/* Ajuste visual Select2 */
.select2-container .select2-selection--single {
    height: 38px;
    padding: 4px 8px;
}

.select2-container--default .select2-selection--single {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 28px;
}

</style>
<script>
document.addEventListener('DOMContentLoaded', function () {

    const totalPedidoEl = document.getElementById('total-pedido');
    const totalPagamentosEl = document.getElementById('total-pagamentos');
    const saldoEl = document.getElementById('saldo-pedido');
    const pagoMsg = document.getElementById('msg-pago');
    const parcialMsg = document.getElementById('msg-parcial');

    function parseMoney(value) {
        if (!value) return 0;
        return parseFloat(value.replace(',', '.')) || 0;
    }

    function formatMoney(value) {
        return value.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function calcularSaldo() {

        const totalPedido = parseMoney(totalPedidoEl.dataset.valor);
        let totalPagamentos = 0;

        document.querySelectorAll('#payments-table tr').forEach(function(row){
            if (row.style.display === 'none') return;

            const input = row.querySelector('input[name$="total_value"]');
            if (input) {
                totalPagamentos += parseMoney(input.value);
            }
        });

        const saldo = totalPedido - totalPagamentos;

        totalPagamentosEl.innerText = 'R$ ' + formatMoney(totalPagamentos);
        saldoEl.innerText = 'R$ ' + formatMoney(saldo);

        pagoMsg.classList.add('d-none');
        parcialMsg.classList.add('d-none');

        if (totalPagamentos > 0 && saldo === 0) {
            pagoMsg.classList.remove('d-none');
        } else if (totalPagamentos > 0 && saldo > 0) {
            parcialMsg.classList.remove('d-none');
        }
    }

    /* ==========================
       ADICIONAR PAGAMENTO
    ========================== */
    const addPaymentBtn = document.getElementById('add-payment');

    if (addPaymentBtn) {
        addPaymentBtn.addEventListener('click', function() {

            const totalForms = document.getElementById('id_payments-TOTAL_FORMS');

            const currentCount = parseInt(totalForms.value);

            const template = document
                .getElementById('empty-payment-template')
                .innerHTML
                .replace(/__prefix__/g, currentCount);

            document
                .getElementById('payments-table')
                .insertAdjacentHTML('beforeend', template);

            totalForms.value = currentCount + 1;
        });
    }

    /* ==========================
       REMOVER PAGAMENTO
    ========================== */
    document.addEventListener('click', function(e){
        if (e.target.classList.contains('remove-payment')) {

            const row = e.target.closest('tr');
            const deleteCheckbox = row.querySelector('input[type="checkbox"]');

            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
            }

            row.style.display = 'none';
            calcularSaldo();
        }
    });

    document.addEventListener('input', function(e){
        if (e.target.name && e.target.name.includes('total_value')) {
            calcularSaldo();
        }
    });

    calcularSaldo();
});
</script>

{% endblock %}
