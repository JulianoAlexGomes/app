{% extends 'base/base.html' %}
{% load static %}
{% block title %}Pedidos{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
.card-dashboard{
    border:none;
    border-radius:14px;
    box-shadow:0 4px 20px rgba(0,0,0,0.05);
}

.table thead th{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.5px;
    background:#f8f9fa;
}

.btn-icon{
    width:36px;
    height:36px;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    border:1px solid #dee2e6;
    background:#fff;
    transition:.2s;
}

.btn-icon:hover{
    transform:scale(1.05);
}

.nav-tabs .nav-link{
    border:none;
    border-radius:8px;
    margin-right:6px;
    font-size:13px;
}

.nav-tabs .nav-link.active{
    background:#0d6efd;
    color:#fff;
}
</style>

<div class="container mt-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0">Pedidos</h4>
    <a href="{% url 'order_create' %}" class="btn btn-primary btn-icon">
        <i class="bi bi-plus-lg"></i>
    </a>
</div>

<!-- DASHBOARD -->
<div class="row mb-4 g-3">

{% for card in summary_cards %}
{% endfor %}

<div class="col-md-2">
    <div class="card card-dashboard border-start border-4 border-secondary">
        <div class="card-body py-2">
            <small class="text-muted">Total</small>
            <h5 class="fw-bold mb-0">{{ summary.total_orders|default:0 }}</h5>
        </div>
    </div>
</div>

<div class="col-md-2">
    <div class="card card-dashboard border-start border-4 border-primary">
        <div class="card-body py-2">
            <small class="text-muted">Valor Total</small>
            <h6 class="fw-bold mb-0 text-primary">
                R$ {{ summary.total_value|floatformat:2|default:"0,00" }}
            </h6>
        </div>
    </div>
</div>

<div class="col-md-2">
    <div class="card card-dashboard border-start border-4 border-info">
        <div class="card-body py-2">
            <small class="text-muted">Orçamento</small>
            <h6 class="fw-bold mb-0 text-info">
                R$ {{ summary.orcamento_value|floatformat:2|default:"0,00" }}
            </h6>
        </div>
    </div>
</div>

<div class="col-md-2">
    <div class="card card-dashboard border-start border-4 border-warning">
        <div class="card-body py-2">
            <small class="text-muted">Em Separação</small>
            <h6 class="fw-bold mb-0 text-warning">
                R$ {{ summary.em_separacao_value|floatformat:2|default:"0,00" }}
            </h6>
        </div>
    </div>
</div>

<div class="col-md-2">
    <div class="card card-dashboard border-start border-4 border-primary">
        <div class="card-body py-2">
            <small class="text-muted">Separado</small>
            <h6 class="fw-bold mb-0 text-primary">
                R$ {{ summary.separado_value|floatformat:2|default:"0,00" }}
            </h6>
        </div>
    </div>
</div>

<div class="col-md-2">
    <div class="card card-dashboard border-start border-4 border-success">
        <div class="card-body py-2">
            <small class="text-muted">Faturado</small>
            <h6 class="fw-bold mb-0 text-success">
                R$ {{ summary.faturado_value|floatformat:2|default:"0,00" }}
            </h6>
        </div>
    </div>
</div>

</div>

<!-- STATUS TABS -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if not current_status %}active{% endif %}"
           href="{% url 'order_list' %}">
            Todos
        </a>
    </li>
    {% for value,label in status_choices %}
    <li class="nav-item">
        <a class="nav-link {% if current_status == value %}active{% endif %}"
           href="?status={{ value }}">
            {{ label }}
        </a>
    </li>
    {% endfor %}
</ul>

<!-- FILTROS -->
<div class="card card-dashboard mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">

            <input type="hidden" name="status" value="{{ current_status }}">

            <div class="col-md-4">
                <label class="form-label">Cliente</label>
                <select name="client" class="form-select">
                    <option value="">Todos</option>
                    {% for client in clients %}
                        <option value="{{ client.id }}"
                            {% if request.GET.client == client.id|stringformat:"s" %}selected{% endif %}>
                            {{ client }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Data inicial</label>
                <input type="date" name="start_date"
                       value="{{ request.GET.start_date }}"
                       class="form-control">
            </div>

            <div class="col-md-2">
                <label class="form-label">Data final</label>
                <input type="date" name="end_date"
                       value="{{ request.GET.end_date }}"
                       class="form-control">
            </div>

            <div class="col-md-2 d-flex gap-2">
                <button class="btn btn-primary btn-icon">
                    <i class="bi bi-search"></i>
                </button>
                <a href="{% url 'order_list' %}"
                   class="btn btn-outline-secondary btn-icon">
                    <i class="bi bi-arrow-clockwise"></i>
                </a>
            </div>

        </form>
    </div>
</div>

<!-- TABELA -->
<div class="card card-dashboard">
<div class="table-responsive">
<table class="table align-middle mb-0">
<thead>
<tr>
    <th>#</th>
    <th>Cliente</th>
    <th>Status</th>
    <th class="text-end">Total</th>
    <th>Criação</th>
    <th class="text-center">Workflow</th>
    <th class="text-center" width="120">Ações</th>
</tr>
</thead>
<tbody>

{% for order in orders %}
<tr>
    <td>{{ order.id }}</td>
    <td>{{ order.client|default:"—" }}</td>

    <td>
        <span class="badge
            {% if order.status == 'DIGITACAO' %}bg-secondary
            {% elif order.status == 'ORCAMENTO' %}bg-info
            {% elif order.status == 'EM_SEPARACAO' %}bg-warning text-dark
            {% elif order.status == 'SEPARADO' %}bg-primary
            {% elif order.status == 'FATURADO' %}bg-success
            {% elif order.status == 'CANCELADO' %}bg-danger{% endif %}">
            {{ order.get_status_display }}
        </span>
    </td>

    <td class="text-end fw-bold text-success">
        R$ {{ order.total_amount }}
    </td>

    <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>

    <!-- WORKFLOW -->
    <td class="text-center">
        {% if order.next_status %}
        <form method="post"
              action="{% url 'order_advance_status' order.id %}"
              class="d-inline">
            {% csrf_token %}
            <button class="btn-icon">
                <i class="bi bi-arrow-right"></i>
            </button>
        </form>
        {% endif %}
    </td>

    <!-- AÇÕES -->
    <td class="text-center">
        <div class="d-flex justify-content-center gap-2">

            <a href="{% url 'order_update' order.id %}"
               class="btn-icon">
                {% if order.can_edit %}
                    <i class="bi bi-pencil"></i>
                {% else %}
                    <i class="bi bi-eye"></i>
                {% endif %}
            </a>

            {% if order.status == 'DIGITACAO' %}
            <a href="{% url 'order_delete' order.id %}"
               class="btn-icon"
               onclick="return confirm('Excluir pedido?')">
                <i class="bi bi-trash"></i>
            </a>
            {% endif %}

        </div>
    </td>
</tr>

{% empty %}
<tr>
    <td colspan="7" class="text-center text-muted py-4">
        Nenhum pedido encontrado
    </td>
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

<!-- PAGINAÇÃO -->
{% if page_obj.has_other_pages %}
<nav class="mt-4">
<ul class="pagination justify-content-end">

{% if page_obj.has_previous %}
<li class="page-item">
    <a class="page-link"
       href="?page={{ page_obj.previous_page_number }}">
        Anterior
    </a>
</li>
{% endif %}

<li class="page-item disabled">
    <span class="page-link">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
    </span>
</li>

{% if page_obj.has_next %}
<li class="page-item">
    <a class="page-link"
       href="?page={{ page_obj.next_page_number }}">
        Próxima
    </a>
</li>
{% endif %}

</ul>
</nav>
{% endif %}

</div>
{% endblock %}
