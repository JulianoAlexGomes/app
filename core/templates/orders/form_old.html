{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if order %}Editar Pedido{% else %}Novo Pedido{% endif %}{% endblock %}

{% block content %}

<h2>{% if order %}Editar Pedido{% else %}Novo Pedido{% endif %}</h2>

<form method="post" id="order-form">
    {% csrf_token %}

    <!-- ================= DADOS DO PEDIDO ================= -->
    <div class="card p-3 mb-4">
        <h5>Dados do Pedido</h5>
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Cliente</label>
                {{ form.client }}
            </div>
        </div>
    </div>

    <!-- ================= ADICIONAR ITEM ================= -->
    <div class="card p-3 mb-4">
        <h5>Adicionar Item</h5>
        <div class="row align-items-end">
            <div class="col-md-4">
                <label class="form-label">Produto</label>
                <select id="product" class="form-control">
                    <option value="">---</option>
                    {% for p in products %}
                        <option value="{{ p.id }}"
                                data-price="{{ p.price }}"
                                data-price1="{{ p.price1 }}">
                            {{ p.name }} (Estoque: {{ p.storage }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Tipo Preço</label>
                <select id="price_type" class="form-control">
                    <option value="price">Varejo</option>
                    <option value="price1">Atacado</option>
                </select>
            </div>

            <div class="col-md-1">
                <label class="form-label">Qtd</label>
                <input type="number" id="quantity" class="form-control" value="1" min="1">
            </div>

            <div class="col-md-1">
                <label class="form-label">Preço</label>
                <input type="number" step="0.01" id="price" class="form-control">
            </div>

            <div class="col-md-1">
                <label class="form-label">Desc.</label>
                <input type="number" step="0.01" id="discount" class="form-control" value="0">
            </div>

            <div class="col-md-1">
                <label class="form-label">Acrés.</label>
                <input type="number" step="0.01" id="addition" class="form-control" value="0">
            </div>

            <div class="col-md-2">
                <button type="button" id="add-item-btn" class="btn btn-success w-100">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- ================= GRID DE ITENS ================= -->
    <div class="card p-3 mb-4">
        <h5>Itens do Pedido</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Qtd</th>
                    <th>Preço</th>
                    <th>Desc.</th>
                    <th>Acrés.</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="items-table">
                {% for item in formset %}
                <tr data-index="{{ forloop.counter0 }}">
                    <td>{% if item.instance.product %}{{ item.instance.product.name }}{% else %}---{% endif %}</td>
                    <td>{{ item.quantity.value }}</td>
                    <td>R$ {{ item.price.value }}</td>
                    <td>R$ {{ item.discount.value }}</td>
                    <td>R$ {{ item.addition.value }}</td>
                    <td>R$ {{ item.instance.subtotal|floatformat:2 }}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-btn" data-index="{{ forloop.counter0 }}">✕</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h5 class="text-end">
            Total:
            <span class="badge bg-primary" id="total">R$ 0,00</span>
        </h5>
    </div>

    <!-- ================= FORMSET ESCONDIDO ================= -->
    <div style="display:none">
        {{ formset.management_form }}
        <div id="formset-container">
            {% for item in formset %}
                <input type="hidden" name="items-{{ forloop.counter0 }}-id" value="{{ item.instance.id }}">
                <input type="hidden" name="items-{{ forloop.counter0 }}-product" value="{{ item.instance.product.id }}">
                <input type="hidden" name="items-{{ forloop.counter0 }}-quantity" value="{{ item.quantity.value }}">
                <input type="hidden" name="items-{{ forloop.counter0 }}-price" value="{{ item.price.value }}">
                <input type="hidden" name="items-{{ forloop.counter0 }}-discount" value="{{ item.discount.value }}">
                <input type="hidden" name="items-{{ forloop.counter0 }}-addition" value="{{ item.addition.value }}">
                <input type="hidden" name="items-{{ forloop.counter0 }}-DELETE" value="0" id="delete-{{ forloop.counter0 }}">
            {% endfor %}
        </div>
    </div>

    <button class="btn btn-primary">Salvar Pedido</button>
</form>

<!-- ================= ALTERAÇÃO DE STATUS ================= -->
{% if order %}
<form method="post" action="{% url 'order_change_status' order.id %}" class="mt-4">
    {% csrf_token %}
    <div class="card p-3">
        <h5>Status do Pedido</h5>
        <select name="status" class="form-control">
            {% for value,label in order.STATUS_CHOICES %}
                <option value="{{ value }}" {% if value == order.status %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-warning mt-2">Alterar Status</button>
    </div>
</form>
{% endif %}

<script src="{% static 'js/order_form.js' %}"></script>

{% endblock %}
