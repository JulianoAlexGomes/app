{% extends 'base/base.html' %}
{% load static %}
{% block title %}Produtos{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
.card-dashboard{
    border:none;
    border-radius:14px;
    box-shadow:0 4px 20px rgba(0,0,0,0.05);
}

.table thead th{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.5px;
    background:#f8f9fa;
}

.btn-icon{
    width:34px;
    height:34px;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    border:1px solid #dee2e6;
    background:#fff;
    transition:.2s;
}

.btn-icon:hover{
    transform:scale(1.05);
}

.btn-primary-icon{
    background:#0d6efd;
    color:#fff;
    border:none;
}

.btn-danger-icon{
    background:#dc3545;
    color:#fff;
    border:none;
}

.preview-image{
    width:60px;
    height:60px;
    object-fit:cover;
    border-radius:8px;
    cursor:pointer;
}

.variant-table{
    background:#f8f9fa;
    border-radius:10px;
}
</style>

<div class="container mt-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0">Produtos</h4>

    <a href="{% url 'product_create' %}"
       class="btn-icon btn-primary-icon">
        <i class="bi bi-plus-lg"></i>
    </a>
</div>

<!-- DASHBOARD -->
<div class="row mb-4 g-3">

    <div class="col-md-3">
        <div class="card card-dashboard border-start border-4 border-primary">
            <div class="card-body py-2">
                <small class="text-muted">Total de Produtos</small>
                <h5 class="fw-bold mb-0">
                    {{ total_products }}
                </h5>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card card-dashboard border-start border-4 border-success">
            <div class="card-body py-2">
                <small class="text-muted">Estoque Total</small>
                <h5 class="fw-bold mb-0 text-success">
                    {{ total_stock }}
                </h5>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card card-dashboard border-start border-4 border-danger">
            <div class="card-body py-2">
                <small class="text-muted">Estoque Baixo (&lt;5)</small>
                <h5 class="fw-bold mb-0 text-danger">
                    {{ low_stock_count }}
                </h5>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card card-dashboard border-start border-4 border-warning">
            <div class="card-body py-2">
                <small class="text-muted">Valor em Estoque</small>
                <h6 class="fw-bold mb-0 text-warning">
                    R$ {{ total_stock_value|floatformat:2 }}
                </h6>
            </div>
        </div>
    </div>

</div>


<!-- BUSCA -->
<div class="card card-dashboard mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">

            <div class="col-md-6">
                <label class="form-label">Buscar produto</label>
                <input type="text"
                       name="q"
                       value="{{ search }}"
                       class="form-control"
                       placeholder="Nome, modelo, cor, SKU ou EAN">
            </div>

            <div class="col-md-3 d-flex gap-2">
                <button class="btn-icon btn-primary-icon">
                    <i class="bi bi-search"></i>
                </button>

                <a href="{% url 'product_list' %}"
                   class="btn-icon">
                    <i class="bi bi-arrow-clockwise"></i>
                </a>
            </div>

        </form>
    </div>
</div>

<!-- TABELA -->
<div class="card card-dashboard">
<div class="table-responsive">
<table class="table align-middle mb-0">
<thead>
<tr>
    <th width="40"></th>
    <th width="80">Imagem</th>
    <th>Produto</th>
    <th class="d-none d-lg-table-cell">Modelo</th>
    <th class="d-none d-lg-table-cell">Cor</th>
    <th class="text-end">Custo</th>
    <th class="text-end d-none d-md-table-cell">Varejo</th>
    <th class="text-end d-none d-md-table-cell">Atacado</th>
    <th class="text-center d-none d-md-table-cell">Reservado</th>
    <th class="text-center">Disponível</th>
    <th class="text-center" width="110">Ações</th>
</tr>
</thead>

<tbody>
{% for product in products %}

<tr>
    <!-- COLLAPSE -->
    <td class="text-center">
        <i class="bi bi-chevron-right"
           role="button"
           data-bs-toggle="collapse"
           data-bs-target="#variants-{{ product.id }}">
        </i>
    </td>

    <!-- IMAGEM -->
    <td>
        {% if product.cover_image %}
            <img src="{{ product.cover_image.0.image.url }}"
                 class="preview-image"
                 data-url="{{ product.cover_image.0.image.url }}">
        {% else %}
            <div style="width:60px;height:60px;background:#f1f1f1;border-radius:8px;"></div>
        {% endif %}
    </td>

    <td>
        <strong>{{ product.id }} - {{ product.name }}</strong>

        {% if product.variants.first %}
            <div class="small text-muted mt-1">
                SKU: {{ product.variants.first.sku }} |
                EAN: {{ product.variants.first.ean13 }}
            </div>
        {% endif %}
    </td>

    <td class="d-none d-lg-table-cell">
        {{ product.model }}
    </td>

    <td class="d-none d-lg-table-cell">
        {{ product.color }}
    </td>

    <td class="text-end text-muted">
        R$ {{ product.cost|floatformat:2 }}
    </td>

    <td class="text-end d-none d-md-table-cell text-success fw-semibold">
        R$ {{ product.price|floatformat:2 }}
    </td>

    <td class="text-end d-none d-md-table-cell text-primary fw-semibold">
        R$ {{ product.price1|floatformat:2 }}
    </td>

    <td class="text-center d-none d-md-table-cell">
        {{ product.stock_reserved }}
    </td>

    <td class="text-center fw-bold">
        {{ product.stock_available }}
    </td>

    <!-- AÇÕES -->
    <td>
        <div class="d-flex justify-content-center gap-2">

            <a href="{% url 'product_update' product.id %}"
               class="btn-icon">
                <i class="bi bi-pencil"></i>
            </a>

            <a href="{% url 'product_delete' product.id %}"
               class="btn-icon btn-danger-icon"
               onclick="return confirm('Excluir produto?');">
                <i class="bi bi-trash"></i>
            </a>

        </div>
    </td>
</tr>

<!-- VARIAÇÕES -->
<tr class="collapse"
    id="variants-{{ product.id }}">
    <td colspan="11">

        {% if product.variants.all %}
        <div class="p-3 variant-table">

            <h6 class="mb-3 text-muted">
                Variações de Tamanho
            </h6>

            <table class="table table-sm align-middle mb-0">
                <thead>
                <tr>
                    <th>Tamanho</th>
                    <th>SKU</th>
                    <th>EAN13</th>
                    <th class="text-center">Estoque</th>
                    <th class="text-center">Reservado</th>
                    <th class="text-center">Disponível</th>
                    <th class="text-center">Ação</th>
                </tr>
                </thead>
                <tbody>

                {% for variant in product.variants.all %}
                <tr>
                    <td><strong>{{ variant.size }}</strong></td>

                    <td>
                        {{ variant.sku }}
                    </td>

                    <td>
                        {{ variant.ean13 }}
                    </td>

                    <td class="text-center">
                        {{ variant.stock_real }}
                    </td>

                    <td class="text-center">
                        {{ variant.stock_reserved }}
                    </td>

                    <td class="text-center fw-semibold">
                        {{ variant.stock_available }}
                    </td>

                    <td class="text-center">
                        <a href="{% url 'stock_movement' variant.id %}"
                           class="btn-icon btn-primary-icon">
                            <i class="bi bi-box-seam"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}

                </tbody>
            </table>

        </div>
        {% else %}
        <div class="p-3 text-muted">
            Produto sem variações
        </div>
        {% endif %}

    </td>
</tr>

{% empty %}
<tr>
    <td colspan="11"
        class="text-center text-muted py-4">
        Nenhum produto encontrado
    </td>
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

</div>

<!-- MODAL PREVIEW -->
<div class="modal fade" id="imagePreviewModalList" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark border-0">
      <div class="modal-body text-center p-0">
        <img id="modalPreviewImageList"
             src=""
             class="img-fluid"
             style="max-height:90vh;">
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("click", function (e) {

    if (e.target.classList.contains("preview-image")) {

        const imageUrl = e.target.dataset.url;
        const modalImg = document.getElementById("modalPreviewImageList");

        modalImg.src = imageUrl;

        const modal = new bootstrap.Modal(
            document.getElementById("imagePreviewModalList")
        );
        modal.show();
    }

});
</script>

{% endblock %}
