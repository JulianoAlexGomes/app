{% extends 'base/base.html' %}

{% block title %}Movimenta√ß√£o de Estoque{% endblock %}

{% block content %}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
    <h2>
        {{ variant.product.name }}
        <small class="text-muted">- Tamanho {{ variant.size }}</small>
    </h2>

    <a href="{% url 'product_list' %}" class="btn btn-outline-secondary">
        ‚Üê Voltar
    </a>
</div>

<!-- üîπ RESUMO DE ESTOQUE POR TAMANHO -->
<div class="d-flex gap-4 mb-4">

    <div>
        <strong>Estoque f√≠sico</strong><br>
        <span class="badge bg-primary fs-6">
            {{ variant.stock_real }}
        </span>
    </div>

    <div>
        <strong>Reservado</strong><br>
        <span class="badge bg-warning text-dark fs-6">
            {{ variant.stock_reserved }}
        </span>
    </div>

    <div>
        <strong>Dispon√≠vel</strong><br>
        <span class="badge bg-success fs-6">
            {{ variant.stock_available }}
        </span>
    </div>

</div>

<hr>

<!-- üîπ NOVA MOVIMENTA√á√ÉO MANUAL -->
<div class="card p-3 mb-4">
    <h5>Nova movimenta√ß√£o</h5>

    <form method="post">
        {% csrf_token %}

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Tipo</label>
                {{ form.entry_type }}
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Quantidade</label>
                {{ form.quantity }}
            </div>
        </div>

        <button class="btn btn-success">
            Registrar
        </button>
    </form>
</div>

<!-- üîπ HIST√ìRICO -->
<div class="card p-3">
    <h5>Hist√≥rico de Movimenta√ß√µes</h5>

    <table class="table table-striped mt-3 align-middle">
        <thead>
            <tr>
                <th>Natureza</th>
                <th>Movimento</th>
                <th>Tamanho</th>
                <th>Qtd</th>
                <th>Data</th>
                <th>Pedido</th>
                <th width="60"></th>
            </tr>
        </thead>
        <tbody>
            {% for mov in movements %}
            <tr>

                <!-- Natureza -->
                <td>
                    {% if mov.movement_type == 'RESERVE' %}
                        <span class="badge bg-warning text-dark">Reserva</span>
                    {% elif mov.movement_type == 'RELEASE' %}
                        <span class="badge bg-secondary">Libera√ß√£o</span>
                    {% elif mov.movement_type == 'SALE' %}
                        <span class="badge bg-danger">Venda</span>
                    {% elif mov.movement_type == 'INITIAL' %}
                        <span class="badge bg-primary">Inicial</span>
                    {% elif mov.movement_type == 'ADJUST' %}
                        <span class="badge bg-info text-dark">Ajuste</span>
                    {% else %}
                        <span class="badge bg-light text-dark">‚Äî</span>
                    {% endif %}
                </td>

                <!-- Movimento -->
                <td>
                    {% if mov.entry_type == 'in' %}
                        <span class="text-success">Entrada</span>
                    {% elif mov.entry_type == 'out' %}
                        <span class="text-danger">Sa√≠da</span>
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>

                <!-- TAMANHO -->
                <td>
                    {{ mov.variant.size }}
                </td>

                <td>{{ mov.quantity }}</td>

                <td>{{ mov.timestamp|date:"d/m/Y H:i" }}</td>

                <td>
                    {% if mov.order_item %}
                        <a href="{% url 'order_update' mov.order_item.order.id %}">
                            {{ mov.order_item.order.id }}
                        </a>
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>

                <!-- A√á√ïES -->
                <td>
                    {% if mov.movement_type == 'INITIAL' or mov.movement_type == 'ADJUST' %}
                    <form method="post" action="{% url 'stock_entry_delete' mov.id %}">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger">‚úï</button>
                    </form>
                    {% endif %}
                </td>

            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">
                    Nenhuma movimenta√ß√£o registrada
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="alert alert-info">
    <ul class="mb-0">
        <li><strong>Reserva</strong>: separa o item para um pedido</li>
        <li><strong>Venda</strong>: baixa definitivamente o estoque</li>
        <li><strong>Libera√ß√£o</strong>: devolve itens reservados</li>
        <li><strong>Ajuste</strong>: corre√ß√µes manuais</li>
    </ul>
</div>

{% endblock %}
