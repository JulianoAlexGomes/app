{% extends 'base/base.html' %}
{% block content %}

<div class="container mt-4">

    <h4>{{ title }}</h4>

    <form method="post">
        {% csrf_token %}

        <div class="card mb-4">
            <div class="card-header">
                Dados do Lançamento
            </div>
            <div class="card-body">

                <div class="row mb-3">
                    <div class="col-md-2">
                        <label>Tipo</label>
                        {{ form.type }}
                    </div>
                    
                    <div class="col-md-4">
                        <label>Cliente</label>
                        {{ form.client }}
                    </div>

                    <div class="col-md-2">
                        <label>Forma de Pagamento</label>
                        {{ form.payment_method }}
                    </div>

                    <div class="col-md-2">
                        <label>Banco</label>
                        {{ form.bank }}
                    </div>

                    <div class="col-md-2">
                        <label>Valor Total</label>
                        {{ form.total_value }}
                    </div>
                </div>

                <div class="mb-3">
                    <label>Descrição</label>
                    {{ form.description }}
                </div>

            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between">
                Parcelas
                <button type="button" class="btn btn-sm btn-success" id="add-parcel">
                    + Adicionar Parcela
                </button>
            </div>

            <div class="card-body">

                {{ formset.management_form }}

                <table class="table table-bordered" id="parcel-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Valor</th>
                            <th>Desconto</th>
                            <th>Acréscimo</th>
                            <th>Vencimento</th>
                            <th>Pago</th>
                            <th width="80">Excluir</th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for form in formset %}
                        <tr class="parcel-form">
                            <td>{{ form.parcel }}</td>
                            <td>{{ form.value }}</td>
                            <td>{{ form.discount }}</td>
                            <td>{{ form.addition }}</td>
                            <td>{{ form.deadline }}</td>
                            <td class="text-center">{{ form.payed }}</td>
                            <td class="text-center">
                                {% if form.instance.pk %}
                                    {{ form.DELETE }}
                                {% else %}
                                    <button type="button" class="btn btn-sm btn-danger remove-row">
                                        X
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>

            </div>
        </div>

        <div class="mt-3 text-end">
            <a href="{% url 'financial_list' %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </div>

    </form>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    const addBtn = document.getElementById("add-parcel");
    const tableBody = document.querySelector("#parcel-table tbody");
    const totalForms = document.getElementById("id_parcels-TOTAL_FORMS");

    addBtn.addEventListener("click", function() {

        const formIndex = totalForms.value;

        const row = document.createElement("tr");
        row.classList.add("parcel-form");

        row.innerHTML = `
            <td><input type="number" name="parcels-${formIndex}-parcel" class="form-control"></td>
            <td><input type="number" step="0.01" name="parcels-${formIndex}-value" class="form-control"></td>
            <td><input type="number" step="0.01" name="parcels-${formIndex}-discount" class="form-control"></td>
            <td><input type="number" step="0.01" name="parcels-${formIndex}-addition" class="form-control"></td>
            <td><input type="date" name="parcels-${formIndex}-deadline" class="form-control"></td>
            <td class="text-center">
                <input type="checkbox" name="parcels-${formIndex}-payed" class="form-check-input">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-danger remove-row">X</button>
            </td>
        `;

        tableBody.appendChild(row);
        totalForms.value = parseInt(totalForms.value) + 1;
    });

    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("remove-row")) {
            e.target.closest("tr").remove();
        }
    });

});
</script>

{% endblock %}
